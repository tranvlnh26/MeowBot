name: MeowBot Multi-OS Build & Compress

on:
    push:
        branches: ["master"]

jobs:
    release:
        name: Build for ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      rid: linux-x64
                      executable: MeowBot
                      archive: MeowBot-linux-x64.tar.gz
                    - os: windows-latest
                      rid: win-x64
                      executable: MeowBot.exe
                      archive: MeowBot-win-x64.zip
                    - os: macos-latest
                      rid: osx-arm64
                      executable: MeowBot
                      archive: MeowBot-osx-arm64.tar.gz

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 9.0.x

            # Cài đặt trình biên dịch cho Linux
            - name: Install Linux Dependencies
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang zlib1g-dev

            - name: Restore
              run: dotnet restore MeowBot.sln

            - name: Publish Native AOT
              run: |
                  dotnet publish MeowBot.csproj \
                    -c Release \
                    -r ${{ matrix.rid }} \
                    -o ./publish \
                    --no-restore \
                    -p:PublishAot=true \
                    -p:StripSymbols=true

            # Nén file trên Windows (sử dụng PowerShell)
            - name: Compress Artifact (Windows)
              if: matrix.os == 'windows-latest'
              run: |
                  Compress-Archive -Path ./publish/${{ matrix.executable }} -DestinationPath ./${{ matrix.archive }}

            # Nén file trên Linux và macOS (sử dụng tar)
            - name: Compress Artifact (Linux/macOS)
              if: matrix.os != 'windows-latest'
              run: |
                  tar -czf ./${{ matrix.archive }} -C ./publish ${{ matrix.executable }}

            # Upload file đã nén
            - name: Upload Compressed Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.archive }}
                  path: ./${{ matrix.archive }}