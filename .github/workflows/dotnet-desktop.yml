name: MeowBot CI/CD & Release

on:
    push:
        tags:
            - "v*" # Chạy khi bạn push tag mới như v1.0.0, v1.1.0...

permissions:
    contents: write # Cấp quyền cho Action để tạo Release

jobs:
    build-and-release:
        name: Build for ${{ matrix.rid }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                include:
                    - os: ubuntu-latest
                      rid: linux-x64
                      executable: MeowBot
                      asset_name: MeowBot-linux-x64.tar.gz
                    - os: windows-latest
                      rid: win-x64
                      executable: MeowBot.exe
                      asset_name: MeowBot-win-x64.zip
                    - os: macos-latest
                      rid: osx-arm64
                      executable: MeowBot
                      asset_name: MeowBot-osx-arm64.tar.gz

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: 9.0.x

            - name: Install Linux Dependencies
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y clang zlib1g-dev

            - name: Restore Dependencies
              run: dotnet restore MeowBot.csproj -r ${{ matrix.rid }}

            - name: Publish Native AOT
              shell: bash
              run: |
                  dotnet publish MeowBot.csproj \
                    -c Release \
                    -r ${{ matrix.rid }} \
                    -o ./publish \
                    --no-restore \
                    -p:PublishAot=true \
                    -p:StripSymbols=true \
                    -p:SelfContained=true

            # Bước nén để đảm bảo file tải về từ Release không bị lỗi
            - name: Archive Binary (Windows)
              if: matrix.os == 'windows-latest'
              shell: pwsh
              run: Compress-Archive -Path ./publish/${{ matrix.executable }} -DestinationPath ./${{ matrix.asset_name }}

            - name: Archive Binary (Linux/macOS)
              if: matrix.os != 'windows-latest'
              run: tar -czf ./${{ matrix.asset_name }} -C ./publish ${{ matrix.executable }}

            # Upload lên GitHub Release
            - name: Upload to GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: ${{ matrix.asset_name }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
